package com.istar.mediabroken.utils

import groovy.util.logging.Slf4j
import org.apache.http.protocol.HTTP

import java.util.regex.Matcher
import java.util.regex.Pattern;

@Slf4j
public class StringUtils {

    private static final String default_sentence_separator = "[àª¿à«€â€”ï½œğŸ»ğŸ§€ğŸŒ­=ï¼/ã€~.â—ã€Šã€‹â€œâ€ï¼ˆï¼‰(),ï¼Œâ€¦ã€‚:ï¼šï¼Ÿ?ï¼!ï¼›;\"ã€ã€‘]"

    public static String stripHtml2(String content) {
// <p>æ®µè½æ›¿æ¢ä¸ºæ¢è¡Œ
        content = content.replaceAll('<p .*?>', '\r\n');
// <br><br/>æ›¿æ¢ä¸ºæ¢è¡Œ
        content = content.replaceAll('<br\\s*/?>', '\r\n');
// å»æ‰å…¶å®ƒçš„<>ä¹‹é—´çš„ä¸œè¥¿
        content = content.replaceAll('\\<.*?>', '');
// è¿˜åŸHTML
        content = content.replaceAll('\r\n', '<br/>')
        return content;
    }


    static Pattern tagPattern = Pattern.compile(/\<.*?>/)
    static Pattern resolveTagPattern = ~/(<p .*?>)|(<br\s*\/?>)|(<\/\s*br\s*\/?>)|(<img.*\/?>)/

    public static String stripHtml(String content) {
        def matcher = tagPattern.matcher(content)
        def sb = new StringBuffer(content.length())
        while (matcher.find()) {
            def tag = matcher.group()

            if (resolveTagPattern.matcher(tag).matches()) {
                matcher.appendReplacement(sb, tag)
            } else {
                matcher.appendReplacement(sb, '')
            }
        }
        matcher.appendTail(sb)
        return sb.toString()
    }

    public static String html2text(String content) {
// <p>æ®µè½æ›¿æ¢ä¸ºæ¢è¡Œ
        content = content.replaceAll('<p .*?>', '\r\n');
// <br><br/>æ›¿æ¢ä¸ºæ¢è¡Œ
        content = content.replaceAll('<br\\s*/?>', '\r\n');
// å»æ‰å…¶å®ƒçš„<>ä¹‹é—´çš„ä¸œè¥¿
        content = content.replaceAll('\\<.*?>', '');
//æ›¿æ¢BR
        content = content.replaceAll('<br/>', '\r\n');
//æ›¿æ¢ç©ºæ ¼è½¬ä¹‰å­—ç¬¦
        content = content.replaceAll('&nbsp;', ' ');
//æ›¿æ¢@å­—ç¬¦
        content = content.replaceAll('&copy;', '@');
        //æ›¿æ¢&å­—ç¬¦
        content = content.replaceAll('&', " ");
        content = content.replaceAll('gt;', "");
        content = content.replaceAll(':', " ");
        content = content.replaceAll('\\?', " ");
        return content;
    }

    static Pattern imgTagPattern = ~/(<img.*\/?>)/
    static Pattern srcPropertyPattern = ~/src=['"](.*?)['"]/

    public static List extractImgUrl(String content) {
        def matcher = tagPattern.matcher(content)
        def list = []
        while (matcher.find()) {
            def tag = matcher.group()
            if (imgTagPattern.matcher(tag).matches()) {
                def srcMatcher = srcPropertyPattern.matcher(tag)
                if (srcMatcher.find()) {
                    list << srcMatcher.group(1)
                }
            }
        }
        return list
    }

    static Pattern tagPattern2 = Pattern.compile(/<b class='high-light'>.*?<\/b>/)

    public static Map extractHighlight(String content) {
        def matcher = tagPattern2.matcher(content)
        Map result = [:]
        while (matcher.find()) {
            String key = matcher.group()
            String value = key.substring(22, key.length() - 4)
            result.put(key, value)
        }
        return result
    }

    public static String solrHtml2text(String content) {
        content = content.trim()
        content = content.replaceAll("\\\\n", '');
        content = content.replaceAll("\\\\t", '');
        content = content.replaceAll("\\\\r", '');
        return content;
    }

    public static String solrText2Html(String content) {
        content = content.trim()
        content = content.replaceAll("\\\\r\\\\n", "<br/>");
        content = content.replaceAll("\\\\n", "<br/>");
        content = content.replaceAll("\\\\t", "  ");
        content = content.replaceAll("\\\\r", "<br/>");
        content = content.replaceAll("<br/><br/>", "<br/>");
        return content;
    }

    public static String ContentText2Html(String content) {
        content=content.replaceAll("ã€€"," ");
//        content = content.replaceAll("/", "|");
        content = content.replaceAll("\\r\\n\\r\\n", "<br>");
        content = content.replaceAll("\\r\\n", "<br>");
        content = content.replaceAll("\\n", "<br>");
        content = content.replaceAll("\\t", "ã€€");
        content = content.replaceAll("\\r", "<br>");
        content = content.replaceAll("\r", "<br>");
        content = content.replaceAll("\n", "<br>");
        content = content.replaceAll("\\>\\s*\\<", "><")
        content = content.replaceAll("(<br>)+", "<br/>")
        StringBuffer stringBuffer = new StringBuffer()
        content.split("<br/>").each {
            if(it.toString().trim()){
                stringBuffer.append("<p>")
                stringBuffer.append(it)
                stringBuffer.append("</p>")
            }
        }
        return stringBuffer.toString();
    }

    public static String Text2Html(String content) {
        content = content.trim()
        content = content.replaceAll("\\r\\n", "<br/>");
        content = content.replaceAll("\\n", "<br/>");
        content = content.replaceAll("\\t", "");
        content = content.replaceAll("\\r", "<br/>");
        content = content.replaceAll("<br/><br/>", "<br/>");
        return content;
    }

    public static String removeSpaceCode(String content) {
        content = content.trim()
        content = content.replaceAll("&#13;", "");
        content = content.replaceAll("\\<p>[ã€€]+", "<p>");
        content = content.replaceAll("\\<p>\\s*", "<p>");
        return content;
    }

    public static String illegalText2Html(String content) {
        content = content.trim()
        content = content.replaceAll("\\r\\n", "");
        content = content.replaceAll("\\n", "");
        content = content.replaceAll("\\t", "");
        content = content.replaceAll("\\r", "");
        content = content.replaceAll("<br/><br/>", "<br/>");
        return content;
    }

    /**
     * ç”¨å•ä¸ªç©ºæ ¼å­—ç¬¦æ›¿æ¢å¤šä¸ªç©ºæ ¼å­—ç¬¦
     * @param str
     * @return
     */
    public static String replaceMultipleSpace(String str){
        str = str.replaceAll("Â ", " ")
        str = str.replaceAll(" +"," ")
        return str
    }

    //åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯ä¸æ˜¯ä»¥æ•°å­—å¼€å¤´
    public static boolean isStartWithNumber(String str) {
        if (str != null && !"".equals(str)){
            if (str.matches("[0-9]+.*")){
                return true
            }else {
                return false
            }
        }
    }

    //å»æ‰å¾®åšæ­£æ–‡åç¼€è§†é¢‘åœ°å€ http://t.cn/RrGZA5m
    public static String removeWeiboSuffix(String str) {
        try {
            if (str != null && !"".equals(str)) {
                int index = str.lastIndexOf("http://t.cn")
                if (str.length() == (index + 19)) {
                    str = str.substring(0, index)
                } else {
                    str = str.substring(0, index) + str.substring(index + 19, str.length())
                }
            }
        }catch (IndexOutOfBoundsException e){
            return str
        }
        return str
    }

    public static void main(String[] args) {
        String a = "#æ³•å›½æ—…è¡Œ# å•Š"
        println(removeWeiboSuffix(a))
    }

    public static String decodeStr(String source) {
        def resultStr = ""
        if (source) {
            if (source.contains("%")) {
                try {
                    resultStr = URLDecoder.decode(source, HTTP.UTF_8)
                } catch (UnsupportedEncodingException e) {
                    log.error("decode exception ::: {}", e)
                }
            } else {
                resultStr = source
            }
        }
        return resultStr
    }

    public static String encodeStr(String source) {
        try {
            if (source) {
                return URLEncoder.encode(source, HTTP.UTF_8)
            } else {
                return ''
            }
        } catch (UnsupportedEncodingException e) {
            log.error("encode exception ::: {}", e)
        }
    }

    public static String removeSpecialCode(String str) {
        String regEx = "[\"ï¼‚`~!@#%^&*()+=|\${}':;',  ã€€ã€€\\[\\].<>/?~ï¼@#ï¿¥%â€¦â€¦&*ï¼ˆï¼‰â€”â€”+|{}ã€ã€‘â€˜ï¼›ï¼šâ€â€œâ€™ã€‚ï¼Œã€ï¼Ÿ]";
        Pattern p = Pattern.compile(regEx);
        Matcher m = p.matcher(str);
        return m.replaceAll("").trim();
    }

    //å…¨ç½‘ç›‘æ§è¡¨è¾¾å¼ä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œé™¤æ‹¬å·å¤–
    public static boolean existSpecialCode(String str) {
        String regEx = "[\"ï¼‚`~!@#%^&*+=|\${}':;',,.\\[\\].<>/?~ï¼@#ï¿¥%â€¦â€¦&*â€”â€”+|{}ã€ã€‘â€˜ï¼›ï¼šâ€â€œâ€™ã€‚ï¼Œã€ï¼Ÿ]";
        Pattern p = Pattern.compile(regEx);
        Matcher m = p.matcher(str);
        return m.find();
    }

    //æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åªæœ‰æ–‡æœ¬ã€æ•°å­—ã€ä¸‹åˆ’çº¿
    public static boolean isLegitimate(String str) {
        String regEx = "^\\w+\$"
        Pattern p = Pattern.compile(regEx);
        Matcher m = p.matcher(str);
        return m.matches()
    }
    //æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åªæœ‰æ•°å­—ä¸­æ–‡ä¸‹åˆ’çº¿
    public static boolean isCheckName(String str) {
        String regEx = "[^(a-zA-Z0-9\\\\u4e00-\\\\u9fa5)]"
        Pattern p = Pattern.compile(regEx);
        Matcher m = p.matcher(str);
        return m.matches()
    }

    //æ£€æŸ¥å¯†ç çš„å®‰å…¨åº¦,6-18ä½ åŒ…å«æ•°å­—ã€å­—æ¯ã€ä¸‹åˆ’çº¿ä¸­è‡³å°‘ä¸¤ç§
    public static boolean securityPwd(String pwd) {
        if (pwd && pwd.length() >= 6 && pwd.length() <= 18) {
            if (isLegitimate(pwd)) {
                //å¦‚æœåªåŒ…å«æ•°å­—æˆ–å­—æ¯æˆ–ä¸‹åˆ’çº¿
                String numReg = "^[0-9]+\$"
                String wordReg = "^[A-Za-z]+\$"
                String lineReg = "^[_]+\$"
                if (Pattern.compile(numReg).matcher(pwd) || Pattern.compile(wordReg).matcher(pwd) || Pattern.compile(lineReg).matcher(pwd)) {
                    return false
                } else {
                    return true
                }
            } else {
                return false
            }
        } else {
            return false
        }
    }

    /**
     * è¿‡æ»¤æ–‡æœ¬ä¸­çš„aæ ‡ç­¾
     * @param str
     * @return
     */
    public static String removeAElement(String str) {
        return str ? str.replaceAll('<a.+href[^>]*>', '').replaceAll('</a>', '') : ''
    }

    public static String isNullOrNot(String str) {
        String strRe = "";
        strRe = (str == null ? "" : html2text(str))
        return strRe
    }

    public static boolean isMobileNumber(String mobiles) {
        return Pattern.compile('^((13[0-9])|(14[0-9])|(15[0-9])|(16[0-9])|(18[0-9])|(17[0-9])|(19[0-9])|(147))\\\\d{8}$').matcher(mobiles).matches();
    }

    /**
     * åˆ‡åˆ†å¥å­
     * @param document
     * @param sentence_separator
     * @return
     */
    static Set<String> splitSentence(String document, String sentence_separator) {
        def map = [:]

        if (sentence_separator == null || sentence_separator.isEmpty()) {
            sentence_separator = default_sentence_separator
        }
        document = document.replaceAll("Â ", "\n").replaceAll("ã€€", "\n")

        for (String line : document.split("[\t\r\n]")) {
            if (line.length() == 0) continue
            for (String sent : line.split(sentence_separator)) {
                if (sent.length() == 0) continue
                for (String str : sent.split("\\s+")) {
                    if (str) {
                        map.put(str, org.apache.commons.lang3.StringUtils.deleteWhitespace(
                                str.replaceAll("Â ", "")
                        ).length())
                    }
                }
            }
        }
        def sort = map.sort { -it.value }

        def set = sort.take(3).keySet()

        return set
    }

    /**
     * javaç”Ÿæˆéšæœºæ•°å­—å’Œå­—æ¯ç»„åˆ
     * @param length[ç”Ÿæˆéšæœºæ•°çš„é•¿åº¦]
     */
    public static String getCharAndNumr(int length) {
        String val = "";
        Random random = new Random();
        for (int i = 0; i < length; i++) {
            // è¾“å‡ºå­—æ¯è¿˜æ˜¯æ•°å­—
            String charOrNum = random.nextInt(2) % 2 == 0 ? "char" : "num";
            // å­—ç¬¦ä¸²
            if ("char".equalsIgnoreCase(charOrNum)) {
                // å–å¾—å¤§å†™å­—æ¯è¿˜æ˜¯å°å†™å­—æ¯
                int choice = random.nextInt(2) % 2 == 0 ? 65 : 97;
                val += (char) (choice + random.nextInt(26));
            } else if ("num".equalsIgnoreCase(charOrNum)) { // æ•°å­—
                val += String.valueOf(random.nextInt(10));
            }
        }
        return val;
    }

    //ç”Ÿæˆword æ—¶å€™url è½¬ä¹‰
    public static String replaceSpecialWord(String str){

        if(str){
            return str.replaceAll("&","&amp;").replaceAll("<","&lt;")
            .replaceAll(">","&gt;").replaceAll("\"","&quot;").replaceAll("'","&apos;")
        }else {
            return ""
        }
    }
}
